var w=Object.defineProperty;var I=(r,t,s)=>t in r?w(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s;var o=(r,t,s)=>(I(r,typeof t!="symbol"?t+"":t,s),s);import{s as y}from"./active-tags-store.c9bbda04.js";import{S as C}from"./store-keys.4d5921a5.js";import{a as V,b as T,c as U}from"./posts.dc576a1a.js";import{B as $}from"./blocking-group-data.5e4f115e.js";import{a as z}from"./tag-utils.ceb6413c.js";const m=()=>({property:"id",direction:"desc"}),k=()=>{const{subscribe:r,set:t,update:s}=y(C.Sort,m());return{subscribe:r,set:t,update(e){s(i=>({...i,...e}))},reset(){t(m())}}},q=k(),S=()=>({scoreValue:0,scoreComparator:">=",rating:"all"}),D=()=>{const{subscribe:r,set:t,update:s}=y(C.Filter,S());return{subscribe:r,set(e){console.log("set store",e),t({...e,scoreValue:e.scoreValue??0})},update(e){console.log("update store",e),s(i=>({...i,...e}))},reset(){t(S())}}},H=D(),K=r=>r==="-"?"-":"",b=r=>r.replaceAll(" ","_"),j=r=>`${K(r.modifier)}${b(r.name)}`,d=r=>{const t=A(r);let s=[...f([...t["+"],...t["-"]])];return t["~"].length>0&&s.push(`( ${f(t["~"]).join(" ~ ")} )`),s.join("+")},l=(r,t,s,e,i,a,c,h)=>{const n=[`sort:${t}:${s}`];if((e!==0||a!==">=")&&n.push(`score:${a}${e}`),i!=="all"&&n.push(`rating:${i}`),r.length>0&&n.push(d(r)),h.length>0){const g=h.map(p=>d(p.tags)).join("+");n.push(g)}if(c.length>0){const g=c.flatMap(u=>$[u]).map(u=>({modifier:"-",name:u})),p=d(g);n.push(p)}return n.join("+")},f=r=>r.map(j),A=r=>{const t={"+":[],"-":[],"~":[]};return r.forEach(s=>t[s.modifier].push(s)),t};class J{constructor(){o(this,"pid");o(this,"tags");o(this,"supertags");o(this,"blockedContent");o(this,"sortProperty");o(this,"sortDirection");o(this,"scoreValue");o(this,"rating");o(this,"scoreComparator");o(this,"tagString");o(this,"apiKey");o(this,"userId");this.pid=0,this.tags=[],this.supertags=[],this.blockedContent=[],this.sortProperty="id",this.sortDirection="desc",this.scoreValue=0,this.rating="all",this.scoreComparator=">=",this.apiKey="",this.userId=""}withPid(t){return this.pid=t,this}withTags(t){return this.tags=t,this}withSupertags(t){return this.supertags=t,this}withSortProperty(t){return this.sortProperty=t,this}withSortDirection(t){return this.sortDirection=t,this}withScoreValue(t){return this.scoreValue=t,this}withScoreComparator(t){return this.scoreComparator=t,this}withRating(t){return this.rating=t,this}withBlockedContent(t){return this.blockedContent=Object.entries(t).filter(([s,e])=>e).map(([s,e])=>s),this}withApiKey(t){return this.apiKey=t||"",this}withUserId(t){return this.userId=t||"",this}async getPageAndCount(){return this.tagString=l(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags),Promise.all([this.getPage(),this.getCount()])}async getPage(){return this.tagString||(this.tagString=l(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags)),V(this.pid,this.tagString,this.apiKey,this.userId)}async getCount(){return this.tagString||(this.tagString=l(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags)),T(this.tagString,this.apiKey,this.userId)}getQuery(){return this.tagString||(this.tagString=l(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags)),U(0,this.tagString,this.apiKey,this.userId)}}const P=";",B=r=>r.replaceAll(" ","+").split(P).map(t=>t.trim()).map(t=>z(t.charAt(0),t.substring(1))),v=r=>r.map(t=>`${t.modifier}${b(t.name)}`).join(P),X=r=>({tags:B(r.get("tags")??""),sort:_(r),filter:F(r)}),E=r=>{const t=new URLSearchParams,{tags:s,sort:e,filter:i}=r;return s&&s.length>0&&t.append("tags",v(s)),e&&(e.property!=="id"||(e==null?void 0:e.direction)!=="desc")&&t.append("sort",M(e)),i&&(i.rating!=="all"||i.scoreComparator!==">="||i.scoreValue!==0)&&t.append("filter",R(i)),t},M=r=>r.property+":"+r.direction,R=r=>{const t=[];if(r.rating!=="all"){const s="rating:"+r.rating;t.push(s)}if(r.scoreComparator!==">="||r.scoreValue!==0){const s="score"+r.scoreComparator+r.scoreValue;t.push(s)}return t.join(";")},_=r=>{try{if(!r.has("sort"))return;const t=r.get("sort")??"",[s,e]=t.split(":");return{property:s,direction:e}}catch{console.warn("Invalid sort provided in url");return}},F=r=>{try{if(!r.has("filter"))return;const s=(r.get("filter")??"").split(";");let e={};return s.forEach(i=>{if(i.startsWith("rating:")){const[,a]=i.split(":");a!=="all"&&(e.rating=a)}if(i.startsWith("score")){const a=i.match(/score(..)(\d+)/);if(a){const[,c,h]=a;e.scoreComparator=c;const n=Number(h);n&&(e.scoreValue=n)}}}),e}catch{console.warn("Invalid sort provided in url");return}},Y=(r,t,s)=>{const e=new URL(location.protocol+"//"+location.host+"/share");return E({tags:r,sort:t,filter:s}).forEach((a,c)=>{e.searchParams.set(c,a)}),e};export{J as S,H as f,Y as g,X as p,q as s};
