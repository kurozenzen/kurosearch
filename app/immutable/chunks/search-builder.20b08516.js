var V=Object.defineProperty;var w=(r,t,s)=>t in r?V(r,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):r[t]=s;var o=(r,t,s)=>(w(r,typeof t!="symbol"?t+"":t,s),s);import{s as C}from"./active-tags-store.80efbdb8.js";import{S as b}from"./store-keys.5df44647.js";import{a as T}from"./tag-utils.ceb6413c.js";import{a as U,b as $,c as z}from"./posts.7a37cd61.js";import{B as k}from"./blocked-content-store.a3596c49.js";const m=()=>({property:"id",direction:"desc"}),D=()=>{const{subscribe:r,set:t,update:s}=C(b.Sort,m());return{subscribe:r,set:t,update(e){s(i=>({...i,...e}))},reset(){t(m())}}},q=D(),S=()=>({scoreValue:0,scoreComparator:">=",rating:"all"}),j=()=>{const{subscribe:r,set:t,update:s}=C(b.Filter,S());return{subscribe:r,set(e){t({...e,scoreValue:e.scoreValue??0})},update(e){s(i=>({...i,...e}))},reset(){t(S())}}},H=j(),v=r=>r==="-"?"-":"",y=r=>r.replaceAll(" ","_"),I=r=>`${v(r.modifier)}${y(r.name)}`,d=r=>{const t=B(r);let s=[...f([...t["+"],...t["-"]])];return t["~"].length>0&&s.push(`( ${f(t["~"]).join(" ~ ")} )`),s.join("+")},l=(r,t,s,e,i,a,c,h)=>{const n=[`sort:${t}:${s}`];if((e!==0||a!==">=")&&n.push(`score:${a}${e}`),i!=="all"&&n.push(`rating:${i}`),r.length>0&&n.push(d(r)),h.length>0){const g=h.map(p=>d(p.tags)).join("+");n.push(g)}if(c.length>0){const g=c.flatMap(u=>k[u]).map(u=>({modifier:"-",name:u})),p=d(g);n.push(p)}return n.join("+")},f=r=>r.map(I),B=r=>{const t={"+":[],"-":[],"~":[]};return r.forEach(s=>t[s.modifier].push(s)),t},P=";",A=r=>r.replaceAll(" ","+").split(P).map(t=>t.trim()).map(t=>T(t.charAt(0),t.substring(1))),E=r=>r.map(t=>`${t.modifier}${y(t.name)}`).join(P),J=r=>({tags:A(r.get("tags")??""),sort:F(r),filter:L(r)}),M=r=>{const t=new URLSearchParams,{tags:s,sort:e,filter:i}=r;return s&&s.length>0&&t.append("tags",E(s)),e&&(e.property!=="id"||(e==null?void 0:e.direction)!=="desc")&&t.append("sort",R(e)),i&&(i.rating!=="all"||i.scoreComparator!==">="||i.scoreValue!==0)&&t.append("filter",_(i)),t},R=r=>r.property+":"+r.direction,_=r=>{const t=[];if(r.rating!=="all"){const s="rating:"+r.rating;t.push(s)}if(r.scoreComparator!==">="||r.scoreValue!==0){const s="score"+r.scoreComparator+r.scoreValue;t.push(s)}return t.join(";")},F=r=>{try{if(!r.has("sort"))return;const t=r.get("sort")??"",[s,e]=t.split(":");return{property:s,direction:e}}catch{console.warn("Invalid sort provided in url");return}},L=r=>{try{if(!r.has("filter"))return;const s=(r.get("filter")??"").split(";");let e={};return s.forEach(i=>{if(i.startsWith("rating:")){const[,a]=i.split(":");a!=="all"&&(e.rating=a)}if(i.startsWith("score")){const a=i.match(/score(..)(\d+)/);if(a){const[,c,h]=a;e.scoreComparator=c;const n=Number(h);n&&(e.scoreValue=n)}}}),e}catch{console.warn("Invalid sort provided in url");return}},X=(r,t,s)=>{const e=new URL(location.protocol+"//"+location.host+"/share");return M({tags:r,sort:t,filter:s}).forEach((a,c)=>{e.searchParams.set(c,a)}),e};class Y{constructor(){o(this,"pid");o(this,"tags");o(this,"supertags");o(this,"blockedContent");o(this,"sortProperty");o(this,"sortDirection");o(this,"scoreValue");o(this,"rating");o(this,"scoreComparator");o(this,"tagString");this.pid=0,this.tags=[],this.supertags=[],this.blockedContent=[],this.sortProperty="id",this.sortDirection="desc",this.scoreValue=0,this.rating="all",this.scoreComparator=">="}withPid(t){return this.pid=t,this}withTags(t){return this.tags=t,this}withSupertags(t){return this.supertags=t,this}withSortProperty(t){return this.sortProperty=t,this}withSortDirection(t){return this.sortDirection=t,this}withScoreValue(t){return this.scoreValue=t,this}withScoreComparator(t){return this.scoreComparator=t,this}withRating(t){return this.rating=t,this}withBlockedContent(t){return this.blockedContent=Object.entries(t).filter(([s,e])=>e).map(([s,e])=>s),this}async getPageAndCount(){return this.tagString=l(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags),Promise.all([this.getPage(),this.getCount()])}async getPage(){return this.tagString||(this.tagString=l(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags)),U(this.pid,this.tagString)}async getCount(){return this.tagString||(this.tagString=l(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags)),$(this.tagString)}getQuery(){return this.tagString||(this.tagString=l(this.tags,this.sortProperty,this.sortDirection,this.scoreValue,this.rating,this.scoreComparator,this.blockedContent,this.supertags)),z(0,this.tagString)}}export{Y as S,H as f,X as g,J as p,q as s};
