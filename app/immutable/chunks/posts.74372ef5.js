import{f,c as T,r as w,R as m,A as l}from"./user-id-store.c896e7fb.js";import{g as h}from"./tag-type-data.934b5280.js";const u=new Map,_=20;let $=null;const L=async(t,e,n="",s="")=>{const r=I(t,e,n,s),c=await f(r,$);p(c);try{let o=await c.json();o=o.filter(i=>i.change);const a=o.map(b);return a.forEach(i=>{u.set(i.id,i),i.tags.forEach(g=>{T(g)})}),a}catch(o){return console.warn("Failed to get posts",o),[]}},M=async(t,e="",n="")=>{const s=await f(R(t,e,n),$);p(s);const r=await s.text(),o=new DOMParser().parseFromString(r,"text/xml"),a=Number(o.getElementsByTagName("posts")[0].getAttribute("count"));return q(a),a},W=async(t,e="",n="")=>{if(!u.has(t)){let r="";n&&e?r=`${m}&s=post&q=index&fields=tag_info&json=1&id=${t}&api_key=${e}&user_id=${n}`:r=`${l}/post?id=${t}`;const c=await fetch(r);p(c);const o=await c.json(),a=b(o[0]);u.set(a.id,a)}const s=u.get(t);if(s===void 0)throw new Error("Post cannot be undefined");return s},p=t=>{if(!t.ok)throw new Error(`getPage failed with http status ${t.status}`)},b=t=>{const e=t.height,n=t.score,s=t.preview_url,r=t.file_url,c=t.parent_id,o=t.sample_url,a=t.sample_width,i=t.sample_height,g=t.rating,d=t.tag_info,P=t.tags,y=t.id,x=t.width,N=t.change,E=t.comment_count,v=t.status,A=t.source;return{preview_url:s,sample_url:o,file_url:r,comment_count:Number(E),height:Number(e),id:Number(y),change:Number(N)*1e3,parent_id:c?Number(c):void 0,rating:g,sample_height:Number(i),sample_width:Number(a),score:Number(n),source:A,status:v,tags:d?U(d):C(P),width:Number(x),type:O(r)}},U=t=>t.map(S).sort(k),C=t=>t.split(" ").map(j),S=({tag:t,count:e,type:n})=>({name:w(t),count:e,type:n}),j=t=>({name:w(t),count:0,type:"ambiguous"}),k=(t,e)=>h(t.type)-h(e.type),I=(t,e,n,s)=>{let r="";return s&&n?r=`${m}&s=post&q=index&fields=tag_info&json=1&api_key=${n}&user_id=${s}&limit=${_}&pid=${t}`:r=`${l}/posts?limit=${_}&pid=${t}`,e===""?r:`${r}&tags=${e}`},R=(t,e,n)=>{let s="";return n&&e?s=`${m}&s=post&q=index&limit=0&api_key=${e}&user_id=${n}`:s=`${l}/count`,t===""?s:`${s}?tags=${t}`},q=t=>{if(typeof t!="number")throw new Error("Unexpected response received in getPage")},O=t=>t.endsWith(".webm")||t.endsWith(".mp4")?"video":t.includes(".gif")?"gif":"image";export{L as a,M as b,I as c,W as g};
